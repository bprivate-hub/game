<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>약수·배수 릴레이 게임</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-900 text-slate-100">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">약수·배수 릴레이 게임</h1>
        <p class="text-slate-400 text-sm">같은 숫자 재사용 금지 · 앞선 수의 약수 또는 배수만 선택</p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <select id="rangeSelect" class="px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 text-sm">
          <option value="10">범위: 1–10</option>
          <option value="20">범위: 1–20</option>
          <option value="30" selected>범위: 1–30</option>
        </select>
        <select id="modeSelect" class="px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 text-sm">
          <option value="coop" selected>모드: 협력(최장 릴레이)</option>
          <option value="versus">모드: 대전(번갈아 내기)</option>
        </select>
        <button id="newGameBtn" class="px-4 py-2 rounded-xl bg-cyan-400/90 hover:bg-cyan-400 text-slate-900 font-bold text-sm">
          새 게임
        </button>
      </div>
    </header>

    <section class="grid md:grid-cols-[1.4fr,0.8fr] gap-4">
      <!-- 숫자 보드 -->
      <div class="p-4 rounded-2xl bg-slate-800/60 ring-1 ring-slate-700/60">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
          <div class="flex items-center gap-2">
            <span class="text-xs text-slate-400">현재 수</span>
            <span id="currentNumber" class="text-2xl font-extrabold">—</span>
          </div>
          <div class="flex items-center gap-3 text-xs">
            <div>
              <span class="text-slate-400">연결 가능</span>
              <span id="playableCount" class="font-bold ml-1">0</span>
            </div>
            <div>
              <span class="text-slate-400">남은 수</span>
              <span id="remainingCount" class="font-bold ml-1">0</span>
            </div>
          </div>
        </div>
        <div id="board" class="grid grid-cols-5 sm:grid-cols-6 lg:grid-cols-10 gap-2">
          <!-- 숫자 버튼이 JS로 생성됩니다 -->
        </div>
      </div>

      <!-- 정보 영역 -->
      <div class="flex flex-col gap-4">
        <div class="p-4 rounded-2xl bg-slate-800/60 ring-1 ring-slate-700/60">
          <h2 class="font-bold mb-2 text-sm">진행 정보</h2>
          <div class="text-xs leading-6">
            <div>모드: <span id="modeLabel" class="font-semibold text-sky-300">협력</span></div>
            <div>턴: <span id="turnInfo" class="font-semibold text-sky-300">-</span></div>
            <div>체인 길이: <span id="chainLen" class="font-semibold">0</span></div>
            <div>사용한 수:</div>
            <div id="usedList" class="font-mono text-[11px] text-slate-200 break-words min-h-[1.5rem]"></div>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button id="undoBtn" class="px-3 py-1.5 rounded-xl bg-slate-700 hover:bg-slate-600 text-xs">
              되돌리기
            </button>
          </div>
        </div>

        <div class="p-4 rounded-2xl bg-slate-800/60 ring-1 ring-slate-700/60">
          <h2 class="font-bold mb-2 text-sm">이전 게임 기록</h2>
          <p class="text-[11px] text-slate-400 mb-2">새 게임을 누르면 지금까지의 체인이 아래에 기록됩니다.</p>
          <ol id="historyList" class="text-[11px] text-slate-300 space-y-1 max-h-32 overflow-y-auto list-decimal pl-4"></ol>
        </div>

        <div class="p-4 rounded-2xl bg-slate-800/60 ring-1 ring-slate-700/60">
          <h2 class="font-bold mb-2 text-sm">규칙</h2>
          <ul class="text-[11px] text-slate-300 list-disc pl-4 space-y-1">
            <li>첫 수는 자유롭게 선택합니다.</li>
            <li>이후에는 직전 수의 <strong>약수</strong> 또는 <strong>배수</strong>만 선택할 수 있습니다.</li>
            <li>같은 수는 한 라운드에서 <strong>한 번만</strong> 사용할 수 있습니다.</li>
            <li>낼 수 있는 수가 없으면 게임이 종료됩니다.<br>대전 모드에서는 해당 플레이어가 패배합니다.</li>
          </ul>
        </div>
      </div>
    </section>

    <footer class="mt-8 text-[11px] text-slate-500">
      © 약수·배수 릴레이 게임 — 교실에서 자유롭게 사용 가능합니다.
    </footer>
  </div>

  <!-- 워터마크 -->
  <div class="fixed bottom-2 right-3 text-[10px] text-slate-500 opacity-70 pointer-events-none select-none">
    Made by 하늘T
  </div>

  <script>
    (function () {
      const $ = (id) => document.getElementById(id);

      const boardEl         = $("board");
      const rangeSelectEl   = $("rangeSelect");
      const modeSelectEl    = $("modeSelect");
      const newGameBtnEl    = $("newGameBtn");
      const undoBtnEl       = $("undoBtn");

      const currentNumberEl = $("currentNumber");
      const playableCountEl = $("playableCount");
      const remainingCountEl= $("remainingCount");
      const chainLenEl      = $("chainLen");
      const usedListEl      = $("usedList");
      const turnInfoEl      = $("turnInfo");
      const modeLabelEl     = $("modeLabel");
      const historyListEl   = $("historyList");

      // 게임 상태
      let N = 30;
      let mode = "coop"; // "coop" | "versus"
      let used = new Set();
      let chain = [];
      let turn = 0; // 0: A, 1: B (versus 모드에서 사용)
      let undoStack = [];
      let gameHistory = [];

      function isDivisorOrMultiple(a, b) {
        if (!a || !b) return false;
        return (a % b === 0) || (b % a === 0);
      }

      function getCandidates(last) {
        const result = [];
        for (let k = 1; k <= N; k++) {
          if (used.has(k)) continue;
          if (last == null) {
            result.push(k);
          } else if (isDivisorOrMultiple(last, k)) {
            result.push(k);
          }
        }
        return result;
      }

      function snapshot() {
        return {
          N,
          mode,
          used: Array.from(used),
          chain: Array.from(chain),
          turn
        };
      }

      function restore(state) {
        N = state.N;
        mode = state.mode;
        used = new Set(state.used);
        chain = Array.from(state.chain);
        turn = state.turn;
        render();
      }

      function pushUndo() {
        undoStack.push(snapshot());
      }

      function handlePlay(num) {
        const last = chain.length ? chain[chain.length - 1] : null;
        const valid = (last == null) || isDivisorOrMultiple(last, num);
        if (used.has(num) || !valid) return;

        pushUndo();
        used.add(num);
        chain.push(num);

        if (mode === "versus") {
          // 턴 교대
          turn = 1 - turn;
        }

        render();
        checkEnd();
      }

      function handleUndo() {
        if (!undoStack.length) return;
        const prev = undoStack.pop();
        restore(prev);
      }

      function resetGame() {
        used = new Set();
        chain = [];
        turn = 0;
        undoStack = [];
        render();
      }

      function archiveCurrentGame() {
        if (!chain.length) return;
        gameHistory.push({
          range: N,
          mode,
          chain: Array.from(chain)
        });
        renderHistory();
      }

      function renderHistory() {
        if (!historyListEl) return;
        historyListEl.innerHTML = "";
        const items = gameHistory.slice().reverse();
        items.forEach((g, idx) => {
          const li = document.createElement("li");
          const labelMode = g.mode === "versus" ? "대전" : "협력";
          li.textContent = `[1–${g.range}, ${labelMode}] 길이 ${g.chain.length}: ` + g.chain.join(" → ");
          historyListEl.appendChild(li);
        });
      }

      function showToast(msg) {
        const div = document.createElement("div");
        div.textContent = msg;
        div.className = "fixed left-1/2 -translate-x-1/2 bottom-6 bg-slate-800 text-slate-100 px-4 py-2 rounded-xl border border-slate-700 shadow-xl text-xs";
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 2200);
      }

      function checkEnd() {
        if (!chain.length) return;
        const last = chain[chain.length - 1];
        const cand = getCandidates(last);
        if (cand.length === 0) {
          if (mode === "versus") {
            // 방금 둔 사람이 이겼고, 다음 턴으로 표시된 사람이 지는 구조
            const loser = (turn === 0) ? "플레이어 A" : "플레이어 B";
            showToast(`종료! 더 이상 낼 수 없습니다. 패배: ${loser}`);
          } else {
            showToast(`종료! 체인 길이: ${chain.length}`);
          }
        }
      }

      function render() {
        const last = chain.length ? chain[chain.length - 1] : null;
        const cand = getCandidates(last);

        // 상단 정보
        currentNumberEl.textContent = last == null ? "—" : String(last);
        playableCountEl.textContent = (last == null) ? (N - used.size) : cand.length;
        remainingCountEl.textContent = (N - used.size);
        chainLenEl.textContent = chain.length;
        usedListEl.textContent = chain.join(", ");

        // 모드/턴 표시
        if (mode === "coop") {
          modeLabelEl.textContent = "협력";
          modeLabelEl.className = "font-semibold text-sky-300";
          turnInfoEl.textContent = "-";
          turnInfoEl.className = "font-semibold text-sky-300";
        } else {
          modeLabelEl.textContent = "대전";
          modeLabelEl.className = "font-semibold text-amber-300";
          const playerLabel = (turn === 0) ? "플레이어 A" : "플레이어 B";
          const colorClass = (turn === 0) ? "text-emerald-300" : "text-rose-300";
          turnInfoEl.textContent = playerLabel;
          turnInfoEl.className = "font-semibold " + colorClass;
        }

        // 보드 렌더링
        boardEl.innerHTML = "";
        const playableSet = new Set(cand);

        // 플레이어별 하이라이트 링 색상
        let highlightClass = "ring-2 ring-violet-300/80";
        if (mode === "versus") {
          highlightClass = (turn === 0)
            ? "ring-2 ring-emerald-300/80"
            : "ring-2 ring-rose-300/80";
        }

        for (let k = 1; k <= N; k++) {
          const btn = document.createElement("button");
          btn.textContent = String(k);
          btn.className = [
            "aspect-square rounded-2xl border text-lg md:text-xl font-extrabold flex items-center justify-center select-none",
            "transition-all",
            used.has(k)
              ? "opacity-30 border-slate-700 bg-slate-800 line-through"
              : "border-slate-700 bg-slate-900 hover:border-slate-500"
          ].join(" ");

          const canPlay = !used.has(k) && (last == null || playableSet.has(k));
          if (canPlay) {
            btn.className += " " + highlightClass;
            btn.addEventListener("click", () => handlePlay(k));
          }

          boardEl.appendChild(btn);
        }
      }

      // 이벤트 바인딩
      rangeSelectEl.addEventListener("change", (e) => {
        const v = parseInt(e.target.value, 10) || 10;
        archiveCurrentGame();
        N = v;
        resetGame();
      });

      modeSelectEl.addEventListener("change", (e) => {
        const m = e.target.value === "versus" ? "versus" : "coop";
        archiveCurrentGame();
        mode = m;
        resetGame();
      });

      newGameBtnEl.addEventListener("click", () => {
        archiveCurrentGame();
        resetGame();
      });

      undoBtnEl.addEventListener("click", () => {
        handleUndo();
      });

      // 초기 렌더
      render();
    })();
  </script>
</body>
</html>
